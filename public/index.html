<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ğŸ¤– è‡ªå‹•è£œå¡æœå‹™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .spinner-reverse {
            animation: spin-reverse 1s linear infinite;
        }
        @keyframes spin-reverse {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }
        
        .progress-button {
            transition: all 0.3s ease;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .progress-button.processing {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            position: relative;
            overflow: hidden;
        }
        
        .progress-button.processing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            z-index: 1;
            animation: progressShimmer 4s ease-in-out infinite;
        }
        
        @keyframes progressShimmer {
            0% { 
                background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 30%, #93c5fd 50%, #1d4ed8 70%, #3b82f6 100%);
                background-size: 200% 100%;
                background-position: -200% 0;
                opacity: 0.9;
            }
            50% {
                background: linear-gradient(90deg, #1d4ed8 0%, #3b82f6 30%, #93c5fd 50%, #3b82f6 70%, #1d4ed8 100%);
                background-size: 200% 100%;
                background-position: 0% 0;
                opacity: 1;
            }
            100% { 
                background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 30%, #93c5fd 50%, #1d4ed8 70%, #3b82f6 100%);
                background-size: 200% 100%;
                background-position: 200% 0;
                opacity: 0.9;
            }
        }
        
        .progress-button.completed {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }
        
        .progress-button.failed {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
        
        .progress-content {
            position: relative;
            z-index: 2;
        }
        
        .status-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
        }
        
        .status-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <!-- æ¨™é¡Œ -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ¤– è‡ªå‹•è£œå¡æœå‹™</h1>
                <p class="text-gray-600">å®‰å…¨ã€å¿«é€Ÿã€ä¾¿åˆ©çš„ç·šä¸Šè£œå¡æœå‹™</p>
                <p class="text-sm text-gray-500 mt-2">ğŸš€ éƒ¨ç½²åœ¨ Google Cloud Run</p>
            </div>

            <!-- å®‰å…¨æ‰¿è«¾ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <span class="text-2xl mr-3">ğŸ”’</span>
                    <div>
                        <h3 class="font-semibold text-blue-900 mb-1">å®‰å…¨æ‰¿è«¾</h3>
                        <p class="text-sm text-blue-800">æ‚¨çš„å¸³è™Ÿå¯†ç¢¼åƒ…ç”¨æ–¼æœ¬æ¬¡è£œå¡ï¼Œä¸æœƒè¢«å„²å­˜æˆ–è¨˜éŒ„</p>
                    </div>
                </div>
            </div>

            <!-- è¡¨å–® -->
            <form id="punchForm" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å…¬å¸ä»£ç¢¼</label>
                        <input type="text" name="companyCode" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="ä¾‹å¦‚ï¼šTNLMG">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç™»å…¥å¸³è™Ÿ</label>
                        <input type="text" name="username" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="æ‚¨çš„å“¡å·¥ç·¨è™Ÿ">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                        <input type="password" name="password" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="æ‚¨çš„ç™»å…¥å¯†ç¢¼">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è£œå¡æ—¥æœŸ</label>
                        <textarea name="records" required rows="6"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                  placeholder="ç¯„ä¾‹æ ¼å¼ï¼š&#10;2025/06/04	ä¸Šç­æœªæ‰“å¡&#10;2025/06/03	ä¸Šç­æœªæ‰“å¡ / ä¸‹ç­æœªæ‰“å¡&#10;2025/06/02	ä¸‹ç­æœªæ‰“å¡"></textarea>
                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ å¯ç›´æ¥å¾ã€Œæ‰“å¡ç•°å¸¸ã€é é¢è¤‡è£½è²¼ä¸Š</p>
                    </div>

                    <button type="submit" id="submitBtn"
                            class="w-full progress-button text-white font-semibold py-3 px-6 rounded-lg hover:shadow-lg transition-all duration-300">
                        <div class="progress-content flex items-center justify-center">
                            <span id="btnIcon" class="text-xl mr-2">ğŸš€</span>
                            <span id="btnText">é–‹å§‹è‡ªå‹•è£œå¡</span>
                            <span id="btnCounter" class="ml-2"></span>
                        </div>
                    </button>
                </div>
            </form>

            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div id="statusSection" class="hidden">
                <div id="status" class="text-sm font-mono bg-gray-100 rounded p-4 min-h-[60px] whitespace-pre-wrap mb-4"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://auto-recheck-service-250768101653.asia-east1.run.app';
        let currentTaskId = null;

        function updateButtonState(state, current = 0, total = 0) {
            const button = document.getElementById('submitBtn');
            const icon = document.getElementById('btnIcon');
            const text = document.getElementById('btnText');
            const counter = document.getElementById('btnCounter');
            
            button.className = 'w-full progress-button text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300';
            
            switch(state) {
                case 'initial':
                    button.classList.remove('processing', 'completed', 'failed');
                    icon.textContent = 'ğŸš€';
                    icon.classList.remove('spinner-reverse');
                    text.textContent = 'é–‹å§‹è‡ªå‹•è£œå¡';
                    counter.textContent = '';
                    button.disabled = false;
                    break;
                case 'processing':
                    button.classList.add('processing');
                    icon.textContent = 'âš™ï¸';
                    icon.classList.add('spinner-reverse');
                    text.textContent = 'è™•ç†ä¸­';
                    counter.textContent = total > 0 ? ` ${current}/${total}` : '';
                    break;
                case 'completed':
                    button.classList.add('completed');
                    icon.textContent = 'âœ…';
                    icon.classList.remove('spinner-reverse');
                    text.textContent = 'è£œå¡å®Œæˆï¼';
                    counter.textContent = '';
                    break;
                case 'failed':
                    button.classList.add('failed');
                    icon.textContent = 'ğŸ”„';
                    icon.classList.remove('spinner-reverse');
                    text.textContent = 'é‡æ–°å˜—è©¦';
                    counter.textContent = '';
                    break;
            }
        }

        function updateStatus(message, isSuccess = false, isError = false) {
            const statusDiv = document.getElementById('status');
            const statusSection = document.getElementById('statusSection');
            
            statusSection.classList.remove('hidden');
            statusDiv.textContent = message;
            
            statusDiv.className = 'text-sm font-mono rounded p-4 min-h-[60px] whitespace-pre-wrap mb-4';
            if (isSuccess) {
                statusDiv.classList.add('status-success');
            } else if (isError) {
                statusDiv.classList.add('status-error');
            } else {
                statusDiv.classList.add('bg-gray-100');
            }
        }

        document.getElementById('punchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                companyCode: formData.get('companyCode'),
                username: formData.get('username'),
                password: formData.get('password'),
                records: formData.get('records').split('\n').map(line => {
                    const match = line.match(/^(\d{4}\/\d{2}\/\d{2})/);
                    if (!match) return null;
                    const date = match[1];
                    let type = '';
                    if (line.includes('ä¸Šç­æœªæ‰“å¡')) type = 'ä¸Šç­æœªæ‰“å¡';
                    if (line.includes('ä¸‹ç­æœªæ‰“å¡')) type = type ? type + ' / ä¸‹ç­æœªæ‰“å¡' : 'ä¸‹ç­æœªæ‰“å¡';
                    return type ? { date, type } : null;
                }).filter(Boolean)
            };
            
            updateButtonState('processing', 0, data.records.length);
            updateStatus('æ­£åœ¨æäº¤ä»»å‹™...');
            
            const inputs = e.target.querySelectorAll('input, textarea');
            inputs.forEach(input => input.disabled = true);
            
            try {
                const response = await fetch(`${API_BASE}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentTaskId = result.taskId;
                    pollStatus(result.taskId);
                } else {
                    throw new Error(result.error || 'æäº¤å¤±æ•—');
                }
            } catch (error) {
                updateButtonState('failed');
                updateStatus('âŒ éŒ¯èª¤ï¼š' + error.message, false, true);
                inputs.forEach(input => input.disabled = false);
            }
        });
        
        async function pollStatus(taskId) {
            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/status/${taskId}`);
                    const status = await response.json();
                    
                    if (!status.success) {
                        throw new Error(status.error || 'æŸ¥è©¢å¤±æ•—');
                    }
                    
                    updateStatus(status.message || 'è™•ç†ä¸­...');
                    
                    if (status.status === 'completed') {
                        updateButtonState('completed');
                        updateStatus('âœ… è£œå¡å®Œæˆï¼', true);
                        setTimeout(() => {
                            const inputs = document.getElementById('punchForm').querySelectorAll('input, textarea');
                            inputs.forEach(input => input.disabled = false);
                            updateButtonState('initial');
                        }, 3000);
                        return;
                    } else if (status.status === 'failed') {
                        updateButtonState('failed');
                        updateStatus('âŒ åŸ·è¡Œå¤±æ•—ï¼š' + (status.error || 'æœªçŸ¥éŒ¯èª¤'), false, true);
                        const inputs = document.getElementById('punchForm').querySelectorAll('input, textarea');
                        inputs.forEach(input => input.disabled = false);
                        return;
                    }
                    
                    setTimeout(poll, 2000);
                } catch (error) {
                    updateButtonState('failed');
                    updateStatus('âŒ éŒ¯èª¤ï¼š' + error.message, false, true);
                    const inputs = document.getElementById('punchForm').querySelectorAll('input, textarea');
                    inputs.forEach(input => input.disabled = false);
                }
            };
            
            poll();
        }
    </script>
</body>
</html>
