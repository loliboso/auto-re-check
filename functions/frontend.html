<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ğŸ¤– è‡ªå‹•è£œå¡æœå‹™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .spinner-reverse {
            animation: spin-reverse 1s linear infinite;
        }
        @keyframes spin-reverse {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }
        
        .progress-button {
            transition: all 0.3s ease;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .progress-button.processing {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            position: relative;
            overflow: hidden;
        }
        
        .progress-button.processing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            z-index: 1;
            animation: progressShimmer 4s ease-in-out infinite;
        }
        
        @keyframes progressShimmer {
            0% { 
                background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 30%, #93c5fd 50%, #1d4ed8 70%, #3b82f6 100%);
                background-size: 200% 100%;
                background-position: -200% 0;
                opacity: 0.9;
            }
            50% {
                background: linear-gradient(90deg, #1d4ed8 0%, #3b82f6 30%, #93c5fd 50%, #3b82f6 70%, #1d4ed8 100%);
                background-size: 200% 100%;
                background-position: 0% 0;
                opacity: 1;
            }
            100% { 
                background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 30%, #93c5fd 50%, #1d4ed8 70%, #3b82f6 100%);
                background-size: 200% 100%;
                background-position: 200% 0;
                opacity: 0.9;
            }
        }
        
        .progress-button.completed {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }
        
        .progress-button.failed {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
        
        .progress-content {
            position: relative;
            z-index: 2;
        }
        
        .status-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
        }
        
        .status-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <!-- æ¨™é¡Œ -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ¤– è‡ªå‹•è£œå¡æœå‹™</h1>
                <p class="text-gray-600">å®‰å…¨ã€å¿«é€Ÿã€ä¾¿åˆ©çš„ç·šä¸Šè£œå¡æœå‹™</p>
                <p class="text-sm text-gray-500 mt-2">ğŸš€ éƒ¨ç½²åœ¨ Firebase Functions</p>
            </div>

            <!-- å®‰å…¨æ‰¿è«¾ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">å®‰å…¨æ‰¿è«¾</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>â€¢ æ‚¨çš„å·¥è™ŸåŠå¯†ç¢¼åƒ…ç”¨æ–¼æœ¬æ¬¡è£œå¡ï¼Œå®Œæˆå¾Œæœƒç«‹å³éŠ·æ¯€</p>
                            <p>â€¢ æ‰€æœ‰è³‡æ–™å‚³è¼¸å‡ä½¿ç”¨ HTTPS åŠ å¯†</p>
                            <p>â€¢ çµ•å°ä¸æœƒå„²å­˜æ‚¨ä»»ä½•çš„å€‹äººè³‡è¨Š</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»è¦è¡¨å–® -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <form id="punchForm" class="space-y-6">
                    <!-- ç™»å…¥è³‡è¨Šå€å¡Š -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“ ç™»å…¥è³‡è¨Š</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å…¬å¸ä»£ç¢¼</label>
                                <input type="text" name="companyCode" value="TNLMG" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å·¥è™Ÿ</label>
                                <input type="text" name="username" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                                <input type="password" name="password" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- è£œå¡æ—¥æœŸå€å¡Š -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“… è£œå¡æ—¥æœŸ</h2>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                è«‹è²¼ä¸Šã€Œæ‰“å¡ç•°å¸¸ã€æŸ¥è©¢çµæœï¼ˆæ”¯æ´åŸå§‹æ ¼å¼ï¼‰
                            </label>
                            <textarea name="records" rows="6" required
                                      placeholder="ä¾‹å¦‚ï¼š&#10;2025/06/04	ä¸Šç­æœªæ‰“å¡&#10;2025/06/03	ä¸Šç­æœªæ‰“å¡ / ä¸‹ç­æœªæ‰“å¡&#10;2025/06/02	ä¸‹ç­æœªæ‰“å¡"
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                        </div>
                    </div>

                    <!-- åŸ·è¡Œç‹€æ…‹å€å¡Š -->
                    <div id="statusSection" class="hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“º åŸ·è¡Œç‹€æ…‹</h2>
                            <div id="status" class="text-sm font-mono bg-gray-100 rounded p-4 min-h-[60px] whitespace-pre-wrap mb-4"></div>
                        </div>
                    </div>

                    <!-- é€²åº¦æ¢æŒ‰éˆ• -->
                    <button type="submit" id="submitBtn"
                            class="progress-button w-full text-white py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all">
                        <div class="progress-content flex items-center justify-center space-x-2">
                            <span id="buttonIcon">ğŸš€</span>
                            <span id="buttonText">é–‹å§‹è‡ªå‹•è£œå¡</span>
                            <span id="buttonCounter"></span>
                        </div>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + window.location.pathname.replace(/\/$/, '');
        let currentTaskId = null;

        function updateButtonState(state, current, total) {
            const button = document.getElementById('submitBtn');
            const icon = document.getElementById('buttonIcon');
            const text = document.getElementById('buttonText');
            const counter = document.getElementById('buttonCounter');
            
            button.className = 'progress-button w-full text-white py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all';
            
            switch(state) {
                case 'initial':
                    icon.textContent = 'ğŸš€';
                    text.textContent = 'é–‹å§‹è‡ªå‹•è£œå¡';
                    counter.textContent = '';
                    break;
                case 'processing':
                    button.classList.add('processing');
                    icon.textContent = 'â†º';
                    icon.classList.add('spinner-reverse');
                    text.textContent = 'è™•ç†ä¸­...';
                    counter.textContent = total > 0 ? ` ${current}/${total}` : '';
                    break;
                case 'completed':
                    button.classList.add('completed');
                    icon.textContent = 'âœ…';
                    icon.classList.remove('spinner-reverse');
                    text.textContent = 'è£œå¡å®Œæˆï¼';
                    counter.textContent = '';
                    break;
                case 'failed':
                    button.classList.add('failed');
                    icon.textContent = 'ğŸ”„';
                    icon.classList.remove('spinner-reverse');
                    text.textContent = 'é‡æ–°å˜—è©¦';
                    counter.textContent = '';
                    break;
            }
        }

        function updateStatus(message, isSuccess = false, isError = false) {
            const statusDiv = document.getElementById('status');
            const statusSection = document.getElementById('statusSection');
            
            statusSection.classList.remove('hidden');
            statusDiv.textContent = message;
            
            statusDiv.className = 'text-sm font-mono rounded p-4 min-h-[60px] whitespace-pre-wrap mb-4';
            if (isSuccess) {
                statusDiv.classList.add('status-success');
            } else if (isError) {
                statusDiv.classList.add('status-error');
            } else {
                statusDiv.classList.add('bg-gray-100');
            }
        }

        document.getElementById('punchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                companyCode: formData.get('companyCode'),
                username: formData.get('username'),
                password: formData.get('password'),
                records: formData.get('records').split('\\n').map(line => {
                    const match = line.match(/^(\\d{4}\\/\\d{2}\\/\\d{2})/);
                    if (!match) return null;
                    const date = match[1];
                    let type = '';
                    if (line.includes('ä¸Šç­æœªæ‰“å¡')) type = 'ä¸Šç­æœªæ‰“å¡';
                    if (line.includes('ä¸‹ç­æœªæ‰“å¡')) type = type ? type + ' / ä¸‹ç­æœªæ‰“å¡' : 'ä¸‹ç­æœªæ‰“å¡';
                    return type ? { date, type } : null;
                }).filter(Boolean)
            };
            
            updateButtonState('processing', 0, data.records.length);
            updateStatus('æ­£åœ¨æäº¤ä»»å‹™...');
            
            const inputs = e.target.querySelectorAll('input, textarea');
            inputs.forEach(input => input.disabled = true);
            
            try {
                const response = await fetch(`${API_BASE}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentTaskId = result.taskId;
                    pollStatus(result.taskId);
                } else {
                    throw new Error(result.error || 'æäº¤å¤±æ•—');
                }
            } catch (error) {
                updateButtonState('failed');
                updateStatus('âŒ éŒ¯èª¤ï¼š' + error.message, false, true);
                inputs.forEach(input => input.disabled = false);
            }
        });
        
        async function pollStatus(taskId) {
            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/status/${taskId}`);
                    const status = await response.json();
                    
                    if (!status.success) {
                        throw new Error(status.error || 'æŸ¥è©¢å¤±æ•—');
                    }
                    
                    updateStatus(status.message || 'è™•ç†ä¸­...');
                    
                    if (status.status === 'completed') {
                        updateButtonState('completed');
                        updateStatus('âœ… è£œå¡å®Œæˆï¼', true);
                        setTimeout(() => {
                            const inputs = document.getElementById('punchForm').querySelectorAll('input, textarea');
                            inputs.forEach(input => input.disabled = false);
                            document.querySelector('input[name="password"]').value = '';
                            updateButtonState('initial');
                        }, 3000);
                    } else if (status.status === 'failed') {
                        updateButtonState('failed');
                        updateStatus('âŒ ' + (status.message || 'è£œå¡å¤±æ•—'), false, true);
                        const inputs = document.getElementById('punchForm').querySelectorAll('input, textarea');
                        inputs.forEach(input => input.disabled = false);
                    } else {
                        setTimeout(poll, 2000);
                    }
                } catch (error) {
                    updateButtonState('failed');
                    updateStatus('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message, false, true);
                    const inputs = document.getElementById('punchForm').querySelectorAll('input, textarea');
                    inputs.forEach(input => input.disabled = false);
                }
            };
            
            poll();
        }
    </script>
</body>
</html>
